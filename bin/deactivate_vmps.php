#!/usr/bin/php -- -f
<?
/**
 * enterprise/deactivate_vmps
 *
 * Long description for file:
 *
 * This script configures all switch ports in the FreeNAC database to static.
 *
 * TESTED:
 *      Catalyst 2940 (IOS), 3560 (IOS), 2948 (CatOS)
 *
 * USAGE :
 *     	deactivate_vmps [switches...]
 *
 * PHP version 5
 *
 * LICENSE: This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public License as published
 * by the Free Software Foundation.
 *
 * package                     FreeNAC
 * author                      Hector Ortiz (FreeNAC Core Team)
 * copyright                   2007 FreeNAC
 * license                     http://www.gnu.org/copyleft/gpl.html   GNU Public License Version 2
 * version                     SVN: $Id$
 * link                        http://www.freenac.net
 *
 */


chdir(dirname(__FILE__));
set_include_path("../:./");
require_once "bin/funcs.inc.php";               # Load settings & common functions
require_once "bin/snmp_defs.inc.php";
$logger->setLogToStdOut();

function print_usage($code)
{
   $usage=<<<EOF
USAGE: deactivate_vmps [switches...] [OPTIONS]

        Web:      http://www.freenac.net/
        Email:    opennac-devellists.sourceforge.net

DESCRIPTION: Deactivate VMPS from the switches specified on the command line which are in the FreeNAC database.
	     Set as the static vlan on the switch port, the last_vlan field from the FreeNAC database.
	     If no switches are specified, it takes the list of all switches present in the FreeNAC database.
	     Changes are stored to an autogenerated file, unless a filename is specified with the -f option.
 	     The default filename is vmps-yyyy-mm-dd-hh:mm:ss

WARNING: No providing a list of switches from the command line, deactivates VMPS in your entire network.
         Use it wisely!

OPTIONS:
        -h              Display this help screen
	-f filename	Save changes to filename 
	-c rw_community	Use this SNMP RW community instead of the one defined in config.inc

EOF;
   $logger->logit( $usage);
   exit($code);
}

$file_timestamp=date('Y-m-d H:i:s');
$file_timestamp=str_replace(' ','-',$file_timestamp);
$file_name=dirname(__FILE__).'/vmps-'.$file_timestamp;

db_connect();
if ($argc>1)
   $options=getopt('hf:c:');

if ($options)						//Simple command line parsing
{
   if (array_key_exists('h',$options))
      print_usage(0);
   if (array_key_exists('f',$options))
      $file_name=dirname(__FILE__).'/'.trim($options['f']);
   if (array_key_exists('c',$options))
      $snmp_rw=trim($options['c']);
}

//
//Take parameters off the command line
//
$j=0;
for ($i=0;$i<$argc;$i++)
{
   switch($argv[$i])
   {
      case '-c':
      case '-f':
         ++$i;
         break;
      case strstr($argv[$i],'-c'):
      case strstr($argv[$i],'-f'):
         break;
      default:
         $command_line[$j]=$argv[$i];
         $j++;
         break;
   }
}

if ($j==1)
{
   $logger->logit( "\nWARNING: You are about to disable VMPS in all switches in your database\n");
   $logger->logit( "\nPress Ctrl+C to stop this task before the timer expires...\n\n");
   for ($i=10;$i>0;$i--)
   {
      $logger->logit( "$i seconds to go...\n");
      sleep(3);
   }
   $logger->logit( "\nProceeding to disable VMPS in all switches registered in the database\n\n");
   $query="select * from switch";
}
else
{
   $query="select * from switch where ";
   for ($i=1;$i<$j;$i++)
   {
      if ($i==1)
         $query.="name like '".mysql_real_escape_string($command_line[$i])."' or ip='".mysql_real_escape_string($command_line[$i])."'";
      else
         $query.="or name like '".mysql_real_escape_string($command_line[$i])."' or ip='".mysql_real_escape_string($command_line[$i])."'";
   }
   $query.=";";
}

while (!$res=mysql_query($query));
$total_switches=mysql_num_rows($res);
if (($argc>1)&&(mysql_num_rows($res)==0))
{
   $logger->logit( "No such name or ip found in the switch table\n");
   exit(1);
}

$counter=0;
$total_ports=0;
$file=fopen($file_name,'w');
if (!$file)
{
   $logger->logit( "Couldn't open file $file_name for writing\n");
   exit(1);
}

while ($result=mysql_fetch_array($res,MYSQL_ASSOC))
{
   $switch=$result['ip'];
   $logger->logit( "Deactivating VMPS on switch $switch\n");
   $ports_on_switch=@snmprealwalk($switch,$snmp_rw,$snmp_if['name']);      	//Get the list of ports on the switch
   if (empty($ports_on_switch))
   {
      $logger->logit( "\tCouldn't establish communication with $switch with the defined parameters.\n");
      continue;
   }
   $ports_on_switch=array_map("remove_type",$ports_on_switch);             	//We are only interested in the string
   $vlans_on_switch=@snmprealwalk($switch,$snmp_rw,$snmp_vlan['name']);  	//Lookup of VLAN in the switch
   if (empty($vlans_on_switch))
   {
     $logger->logit( "\tCouldn't establish communication with $switch. This may be due to a network failure.\n");
     continue;
   }
   $vlans_on_switch=array_map("remove_type",$vlans_on_switch);
   $query="select p.name as port_name, v.default_name as vlan from port p inner join switch sw on p.switch=sw.id inner join vlan v on p.last_vlan=v.id where p.last_vlan>2 and p.auth_profile='2' and sw.ip='$switch';";
   while (!$res1=mysql_query($query));						//Execute query
   $total_ports+=mysql_num_rows($res1);
   $counter=0;
   while ($result1=mysql_fetch_array($res1,MYSQL_ASSOC))
   {
      $port=$result1['port_name'];
      $static_vlan=$result1['vlan'];
   
      $port_oid=array_search($port,$ports_on_switch);                         	//Is the port present in this switch?
      if (empty($port_oid))
      {
         $logger->logit( "\tPort $port not found on switch $switch\n");
         continue;
      }
      $port_index=get_last_index($port_oid);                                  	//Port found, get the index
      
      $vlan_oid=array_search($static_vlan,$vlans_on_switch);                	//Is the VLAN present in the switch?
      if (empty($vlan_oid))
      {
         $logger->logit( "\tVLAN $static_vlan not found on switch $switch.\n");
         continue;
      }
      $vlan=get_last_index($vlan_oid);                                      	//VLAN found, get the index

      if (turn_off_port($port_index))							//Shut down port to configure it
      {
         $oid=$snmp_port['type'].'.'.$port_index;
         if (snmpset($switch,$snmp_rw,$oid,'i',1))                             	//Set port to static
         {
            $oid=$snmp_if['vlan'].'.'.$port_index;
            fprintf($file,"%s,%s,",$switch,$port);
            if (snmpset($switch,$snmp_rw,$oid,'i',$vlan))                      	//And set the VLAN on that port
            {
               fprintf($file,"%s\n",$static_vlan);
               if (turn_on_port($port_index))						//Done, turn it on
               {
                  $logger->logit( "\tPort $port successfully set to static with VLAN $static_vlan.\n");
                  $counter++;
               }
            }
            else
               fprintf($file,"\n");
         }
      }
   }
   if ($counter>0)
   {
      $string="$counter ports affected in switch $switch";
      $logger->logit( "\n\t$string\n\n");
      $logger->setLogToStdOut(false);
      $logger->logit($string);
      $logger->setLogToStdOut();
      log2db('info',"deactivate_vmps: ".$string);
   }

   $text=array_map("remove_type",@snmprealwalk($switch,$snmp_rw,$snmp_sw['descr']));          //Determine if switch is IOS
   $ios=0;
   foreach($text as $string)
   {
      if (strpos($string,'IOS'))
         $ios++;
   }
   $old=0;
   $written=0;
   if ($ios)                                                                                 //Switch is an IOS, perform a 'wr' using the old way
   {
      if (snmpset($switch,$snmp_rw,$write_command['old'].'.0','i',1))
      {
         $old++;
         $written++;
         $logger->logit( "\tCurrent configuration saved to switch $switch\n\n");
      }
      else if (snmpset($switch,$snmp_rw,$write_command['old'],'i',1))
      {
         $old++;
         $written++;
         $logger->logit( "\tCurrent configuration saved to switch $switch\n\n");
      }
   }
   if ($ios&&!$old)                                                                          //Old way didn't work, try the new one
   {                                                                                         //NOTE: This code below hasn't been tested
      $rand_val=rand(1,999);
      if (snmpset($switch,$snmp_rw,$write_command['source'].'.'.$rand_val,'i',2))
      {
         if (snmpset($switch,$snmp_rw,$write_command['destination'].'.'.$rand_val,'i',1))
         {
            if (snmpset($switch,$snmp_rw,$write_command['execute'].'.'.$rand_val,'i',4))
               $written++;
         }
      }
   }
   if ($ios&&!$written)
   {
      $logger->logit( "\tCouldn't save current configuration to switch $switch\n\n");
   }
}
fclose($file);
if ($j==1)
{
   $total_db=v_sql_1_select("select count(*) from port where auth_profile='2';");
   $string="Switches in total: $total_switches\tPorts affected: $total_ports out of $total_ports\tNumber of ports to be affected (from db): $total_db";
   $logger->logit( "$string\n");
   $logger->setLogToStdOut(false);
   $logger->logit($string);
   $logger->setLogToStdOut();
   log2db('info',"deactivate_vmps: ".$string);
}
else
{
   $string="Switches in total: $total_switches\tPorts affected: $total_ports out of $total_ports";
   $logger->logit( "$string\n");
   $logger->setLogToStdOut(false);
   $logger->logit($string);
   $logger->setLogToStdOut();
   log2db('info',"deactivate_vmps: ".$string);

}
$string="deactivate_vmps has finished. Change file: $file_name";
$logger->logit("\n\n$string\n");
log2db('info',$string);

exit(0);


?>


